<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Title will be set dynamically -->
    <title>AI Clone - Manage Clone</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <h1 id="manage-title">Manage Clone</h1>

        <div id="flash-messages" class="flash-messages" style="display: none;">
            <!-- JS will populate this -->
        </div>

        <div id="loading-state" class="loading-state">Loading clone details...</div>

        <div id="settings-card" class="card" style="display: none;">
            <h2>Clone Settings</h2>
            <p>Update your clone's settings below.</p>

            <!-- Removed action and method -->
            <form id="manage-clone-form">
                <div class="form-group">
                    <label for="clone_name">Clone's Name:</label>
                    <input type="text" name="clone_name" id="clone_name" required>
                </div>

                <div class="form-group">
                    <label for="clone_role">Category:</label>
                    <select name="clone_role" id="clone_role" required>
                        <option value="" disabled>Select a Role...</option>
                        <!-- Options will be populated by JS, but keep static list as fallback/reference -->
                        <option value="Characters">Characters</option>
                        <option value="Coaches">Coaches</option>
                        <option value="Therapists">Therapists</option>
                        <option value="Games">Games</option>
                        <option value="Historical">Historical</option>
                        <option value="Religion">Religion</option>
                        <option value="Animals">Animals</option>
                        <option value="Discussion">Discussion</option>
                        <option value="Comedy">Comedy</option>
                        <option value="Other">Other</option>
                        <option value="Authors and books">Authors and books</option>
                        <option value="Celebrities">Celebrities</option>
                        <option value="Influencers">Influencers</option>
                        <option value="Companions">Companions</option>
                        <option value="Romantic">Romantic</option>
                        <option value="Family">Family</option>
                        <option value="Me!">Me!</option>
                        <option value="Expert">Expert</option>
                        <option value="Regular people">Regular people</option>
                        <option value="CEO">CEO</option>
                        <option value="Consultant">Consultant</option>
                        <option value="Spokesperson">Spokesperson</option>
                    </select>
                    <small>Select the role that best fits your clone. Changing this may affect the enhanced persona.</small>
                </div>

                <div class="form-group">
                    <label for="clone_description">Clone Description:</label>
                    <textarea name="clone_description" id="clone_description" rows="2" placeholder="Write a short description that will tell users about your bot. This will not impact the bot's behavior."></textarea>
                </div>

                <div class="form-group">
                    <label for="original_persona">Original Clone Prompt:</label>
                    <textarea name="original_persona" id="original_persona" rows="4" required></textarea>
                    <small>This is the persona description you provided. Edit this field to update the clone's core instructions.</small>
                </div>

                <div class="form-group">
                    <label for="enhanced_persona">Enhanced Clone Prompt (Read-Only):</label>
                    <textarea name="enhanced_persona" id="enhanced_persona" rows="6" readonly></textarea>
                    <small>This is the AI-enhanced version of your description, used during chat. It's automatically updated when you save changes to the original description.</small>
                </div>

                <div class="form-group">
                    <label for="drive_folder">Google Drive Folder Link (Optional):</label>
                    <input type="url" name="drive_folder" id="drive_folder">
                    <small>Paste the URL of a Google Drive folder containing your documents (optional). You can leave this field empty and the clone will still work.</small>
                </div>

                <div class="form-group">
                    <label for="vectorstore_name">Vectorstore Name (Read-Only):</label>
                    <input type="text" name="vectorstore_name" id="vectorstore_name" readonly>
                    <small>This is the name of the vectorstore collection used by this clone. This field is read-only.</small>
                </div>

                <!-- Google Drive Import Section -->
                <div class="card sub-card" style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee;">
                    <h4>Google Drive Document Import</h4>
                    <p>To import documents from a Google Drive folder:</p>
                    <ol style="margin-left: 20px; margin-bottom: 15px;">
                        <li>Go to the folder in your Google Drive.</li>
                        <li>Click the "Share" button.</li>
                        <li>Paste the following email address into the sharing dialog: <br>
                            <strong id="service-account-email" style="user-select: all; background-color: #f0f0f0; padding: 2px 4px; border-radius: 3px;">ragie-drive-reader@prototype-app-456908.iam.gserviceaccount.com</strong>
                            <button type="button" class="btn-copy" onclick="copyEmail()" style="margin-left: 5px; padding: 2px 6px; font-size: 0.8em;">Copy</button>
                        </li>
                        <li>Set the permission level to at least "Viewer".</li>
                        <li>Click "Share" or "Send".</li>
                        <li>Copy the URL of the shared folder.</li>
                        <li>Paste the folder URL into the field below and click "Import".</li>
                    </ol>
                    <div class="form-group">
                        <label for="drive_folder_import">Google Drive Folder Link:</label>
                        <input type="url" name="drive_folder_import" id="drive_folder_import" placeholder="Paste shared folder URL here" style="width: calc(100% - 22px);">
                    </div>
                    <div class="form-group">
                         <button type="button" id="import-drive-button" class="btn btn-secondary">Import</button>
                    </div>
                     <div id="import-status" class="import-status" style="margin-top: 10px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; background-color: #f9f9f9;">Import Status: Idle</div>
                </div>
                <!-- End Google Drive Import Section -->


                <div class="form-group">
                    <button type="submit" id="save-button" class="btn">Save Changes</button>
                    <!-- Link to frontend directory -->
                    <a href="{{ url_for('clone_directory') }}" class="btn btn-secondary">Back to Directory</a>
                </div>
            </form>

            <div class="danger-zone">
                <h3>Danger Zone</h3>
                <p>Deleting a clone is permanent and cannot be undone.</p>
                <!-- Removed form, button now handled by JS -->
                <button id="delete-button" class="btn btn-danger">Delete Clone</button>
            </div>
        </div>
    </div>

    <script>
        const backendApiUrl = "{{ backend_api_url }}"; // Get URL from Flask
        const cloneId = "{{ clone_id }}"; // Get clone_id from Flask route
        const form = document.getElementById('manage-clone-form');
        const saveButton = document.getElementById('save-button');
        const deleteButton = document.getElementById('delete-button');
        const flashMessagesContainer = document.getElementById('flash-messages');
        const loadingState = document.getElementById('loading-state');
        const settingsCard = document.getElementById('settings-card');
        const manageTitle = document.getElementById('manage-title');
        const importDriveButton = document.getElementById('import-drive-button');
        const importStatusDiv = document.getElementById('import-status');
        const driveFolderImportInput = document.getElementById('drive_folder_import');
        let pollingIntervalId = null; // To store the interval ID for polling

        // Function to copy email
        function copyEmail() {
            const email = document.getElementById('service-account-email').innerText;
            navigator.clipboard.writeText(email).then(() => {
                displayFlashMessage('Service account email copied!', 'success');
            }).catch(err => {
                console.error('Failed to copy email: ', err);
                displayFlashMessage('Failed to copy email.', 'error');
            });
        }

        // Function to display messages
        function displayFlashMessage(message, type = 'info') {
            flashMessagesContainer.innerHTML = ''; // Clear previous
            const messageDiv = document.createElement('div');
            messageDiv.className = `flash-message flash-${type}`;
            messageDiv.textContent = message;
            flashMessagesContainer.appendChild(messageDiv);
            flashMessagesContainer.style.display = 'block';
            window.scrollTo(0, 0); // Scroll to top
        }

        // Function to populate form fields
        function populateForm(cloneData) {
            if (!cloneData) return;
            document.title = `AI Clone - Manage ${cloneData.clone_name || 'Clone'}`;
            manageTitle.textContent = `Manage Clone: ${cloneData.clone_name || ''}`;
            form.elements['clone_name'].value = cloneData.clone_name || '';
            form.elements['clone_role'].value = cloneData.clone_role || '';
            form.elements['clone_description'].value = cloneData.clone_description || '';
            form.elements['original_persona'].value = cloneData.original_persona || '';
            form.elements['enhanced_persona'].value = cloneData.enhanced_persona || '';
            form.elements['drive_folder'].value = cloneData.drive_folder || '';
            form.elements['vectorstore_name'].value = cloneData.vectorstore_name || 'Not set';
        }

        // Fetch clone data on page load
        async function fetchCloneDetails() {
            loadingState.style.display = 'block';
            settingsCard.style.display = 'none';
            flashMessagesContainer.style.display = 'none';

            if (!backendApiUrl) {
                displayFlashMessage('Error: Backend API URL not configured.', 'error');
                loadingState.textContent = 'Error: Backend API URL not configured.';
                return;
            }
            if (!cloneId) {
                 displayFlashMessage('Error: Clone ID missing.', 'error');
                 loadingState.textContent = 'Error: Clone ID missing.';
                 return;
            }

            try {
                const response = await fetch(`${backendApiUrl}/api/clones/${cloneId}`, {
                    credentials: 'include'
                });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: 'Failed to fetch clone details.' }));
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }
                const cloneData = await response.json();
                populateForm(cloneData);
                // Also populate the import URL field if it exists in main data
                driveFolderImportInput.value = cloneData.drive_folder || '';
                loadingState.style.display = 'none';
                settingsCard.style.display = 'block';

                // Check initial import status after loading details
                if (cloneData.ingestion_status === 'processing' || cloneData.ingestion_status === 'pending') {
                    updateImportStatus(cloneData); // Update display immediately
                    startPolling(); // Start polling if already processing
                } else {
                    updateImportStatus(cloneData); // Show final status (complete/error/idle)
                }

            } catch (error) {
                console.error('Error fetching clone details:', error);
                loadingState.style.display = 'none';
                displayFlashMessage(`Error loading clone details: ${error.message}`, 'error');
            }
        }

        // Function to update import status display
        function updateImportStatus(statusData) {
            let statusText = `Import Status: ${statusData.status || 'Unknown'}`;
            if (statusData.status === 'processing' || statusData.status === 'pending') {
                statusText += ` (Attempted: ${statusData.files_attempted || 0}, Processed: ${statusData.files_processed || 0})`;
                importDriveButton.disabled = true;
                importDriveButton.textContent = 'Importing...';
            } else {
                 // Check if processing is finished based on file counts, even if status is not 'complete' yet
                 const isFinished = (statusData.files_attempted !== undefined && statusData.files_processed === statusData.files_attempted);
                 
                 if (isFinished && statusData.status !== 'error') {
                    // Override status text if counts match and no error
                    statusText = `Import Status: complete (Processed ${statusData.files_processed || 0} of ${statusData.files_attempted} files)`;
                 } else if (statusData.files_attempted !== undefined) {
                     // Otherwise, append counts as before
                     statusText += ` (Processed ${statusData.files_processed || 0} of ${statusData.files_attempted} files)`;
                 }

                 if (statusData.error) { 
                     statusText += ` - Error: ${statusData.error}`;
                 }
                 importDriveButton.disabled = false;
                 importDriveButton.textContent = 'Import'; 
            }
            importStatusDiv.textContent = statusText;
            // Add a class for potential styling based on status
            importStatusDiv.className = `import-status status-${(statusData.status || 'unknown').toLowerCase()}`;
        }

        // Function to poll import status
        async function pollImportStatus() {
            if (!backendApiUrl || !cloneId) return;

            try {
                const response = await fetch(`${backendApiUrl}/api/clone_status/${cloneId}`, { credentials: 'include' });
                if (!response.ok) {
                    console.error(`Status check failed: ${response.status}`);
                    // Stop polling on server errors or if clone not found
                    if (response.status >= 500 || response.status === 404) {
                        stopPolling();
                        importStatusDiv.textContent = 'Import Status: Error checking status.';
                        importDriveButton.disabled = false;
                        importDriveButton.textContent = 'Import'; // Changed text
                    }
                    return;
                }
                const statusData = await response.json();
                updateImportStatus(statusData);

                // Stop polling if complete or error
                if (statusData.status === 'complete' || statusData.status === 'error') {
                    stopPolling();
                }
            } catch (error) {
                console.error('Error polling import status:', error);
                importStatusDiv.textContent = 'Import Status: Network error checking status.';
                stopPolling(); // Stop polling on network errors
                importDriveButton.disabled = false;
                importDriveButton.textContent = 'Import'; // Changed text
            }
        }

        // Function to start polling
        function startPolling() {
            stopPolling(); // Clear any existing interval
            console.log("Starting status polling...");
            pollImportStatus(); // Poll immediately
            pollingIntervalId = setInterval(pollImportStatus, 5000); // Poll every 5 seconds
        }

        // Function to stop polling
        function stopPolling() {
            if (pollingIntervalId) {
                clearInterval(pollingIntervalId);
                pollingIntervalId = null;
                console.log("Stopped status polling.");
            }
        }

        // Handle form submission (Update)
        form.addEventListener('submit', async (event) => {
            event.preventDefault();
            saveButton.disabled = true;
            saveButton.textContent = 'Saving...';
            flashMessagesContainer.style.display = 'none';

            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            try {
                const response = await fetch(`${backendApiUrl}/api/clones/${cloneId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data),
                    credentials: 'include'
                });

                const result = await response.json();

                if (response.ok) {
                    console.log('Update successful:', result);
                    displayFlashMessage('Clone updated successfully!', 'success');
                    // Re-populate form with potentially updated data (like enhanced_persona)
                    populateForm(result.clone);
                } else {
                    console.error('Update failed:', result);
                    displayFlashMessage(result.error || 'Failed to update clone.', 'error');
                }
            } catch (error) {
                console.error('Network or other error during update:', error);
                displayFlashMessage('An unexpected error occurred during update.', 'error');
            } finally {
                saveButton.disabled = false;
                saveButton.textContent = 'Save Changes';
            }
        });

        // Handle Delete button click
        deleteButton.addEventListener('click', async () => {
            if (!confirm('Are you sure you want to delete this clone? This action cannot be undone.')) {
                return;
            }

            deleteButton.disabled = true;
            deleteButton.textContent = 'Deleting...';
            flashMessagesContainer.style.display = 'none';

            try {
                const response = await fetch(`${backendApiUrl}/api/clones/${cloneId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                const result = await response.json();

                if (response.ok) {
                    console.log('Delete successful:', result);
                    // Store success message for directory page
                    localStorage.setItem('flashMessage', 'Clone deleted successfully!');
                    window.location.href = '/directory'; // Redirect to frontend directory
                } else {
                    console.error('Delete failed:', result);
                    displayFlashMessage(result.error || 'Failed to delete clone.', 'error');
                    deleteButton.disabled = false;
                    deleteButton.textContent = 'Delete Clone';
                }
            } catch (error) {
                console.error('Network or other error during delete:', error);
                displayFlashMessage('An unexpected error occurred during deletion.', 'error');
                deleteButton.disabled = false;
                deleteButton.textContent = 'Delete Clone';
            }
        });

        // Handle Import button click
        importDriveButton.addEventListener('click', async () => {
            const folderUrl = driveFolderImportInput.value.trim();
            if (!folderUrl) {
                displayFlashMessage('Please paste the Google Drive folder URL first.', 'error');
                return;
            }
            // Basic URL validation (optional, can be more robust)
            try {
                new URL(folderUrl);
            } catch (_) {
                displayFlashMessage('Invalid Google Drive folder URL format.', 'error');
                return;
            }

            importDriveButton.disabled = true;
            importDriveButton.textContent = 'Starting Import...';
            flashMessagesContainer.style.display = 'none';
            importStatusDiv.textContent = 'Import Status: Initiating...';

            try {
                const response = await fetch(`${backendApiUrl}/api/clones/${cloneId}/import_drive`, {
                    method: 'POST',
                    // No body needed as the backend gets URL from clone data now
                    // headers: { 'Content-Type': 'application/json' },
                    // body: JSON.stringify({ drive_folder: folderUrl }), // Send URL if backend needs it
                    credentials: 'include'
                });

                const result = await response.json();

                if (response.status === 202) { // 202 Accepted means background task started
                    displayFlashMessage(result.message || 'Import process started.', 'success');
                    importStatusDiv.textContent = 'Import Status: Processing...';
                    startPolling(); // Start polling for status updates
                } else if (response.ok) { // Handle other potential success codes if needed
                     displayFlashMessage(result.message || 'Request successful, check status.', 'info');
                     // Optionally start polling here too if backend might return 200 immediately
                }
                 else {
                    console.error('Import request failed:', result);
                    displayFlashMessage(result.error || 'Failed to start import process.', 'error');
                    importDriveButton.disabled = false;
                    importDriveButton.textContent = 'Import'; // Changed text
                    importStatusDiv.textContent = 'Import Status: Failed to start.';
                }
            } catch (error) {
                console.error('Network or other error during import request:', error);
                displayFlashMessage('An unexpected error occurred when starting the import.', 'error');
                importDriveButton.disabled = false;
                importDriveButton.textContent = 'Import'; // Changed text
                importStatusDiv.textContent = 'Import Status: Error starting.';
            }
            // Note: Button state (disabled/text) will be managed by the polling function after this point if successful
        });


        // Initial fetch when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            fetchCloneDetails();
            // Optional: Stop polling if user navigates away
            window.addEventListener('beforeunload', stopPolling);
        });
    </script>
</body>
</html>
