<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Clone - Clone Directory</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <h1>Clone Directory</h1>

        <div id="flash-messages" class="flash-messages" style="display: none;">
            <!-- JS will populate this -->
        </div>

        <div class="action-buttons">
            <!-- Link to the frontend route -->
            <a href="{{ url_for('create_clone_page') }}" class="btn">Create New Clone</a>
        </div>

        <div id="clone-list-container">
            <!-- Clone cards will be loaded here by JavaScript -->
            <div class="loading-state">Loading clones...</div>
        </div>

        <div id="empty-state" class="empty-state" style="display: none;">
            <p>You don't have any clones yet. Create your first clone to get started!</p>
        </div>
    </div>

    <script>
        console.log('[Clone Directory] Script block started.');

        const backendApiUrl = "{{ backend_api_url }}";
        const cloneListContainer = document.getElementById('clone-list-container');
        const emptyState = document.getElementById('empty-state');
        const flashMessagesContainer = document.getElementById('flash-messages');

        function displayFlashMessage(message, type = 'info') {
            const messageDiv = document.createElement('div');
            messageDiv.className = `flash-message flash-${type}`;
            messageDiv.textContent = message;
            flashMessagesContainer.appendChild(messageDiv);
            flashMessagesContainer.style.display = 'block';
        }

        async function fetchClones() {
            console.log('[fetchClones] Function started.');
            if (!backendApiUrl) {
                console.error('[fetchClones] Error: Backend API URL not configured.');
                cloneListContainer.innerHTML = '<div class="error-state">Error: Backend API URL not configured.</div>';
                return;
            }

            try {
                console.log('[fetchClones] Attempting to fetch clones list...');
                const response = await fetch(`${backendApiUrl}/api/clones`, {
                     credentials: 'include'
                });
                console.log(`[fetchClones] Clones list fetch response status: ${response.status}`);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const clones = await response.json();
                console.log('[fetchClones] Clones list fetched:', clones);

                cloneListContainer.innerHTML = '';

                if (clones && clones.length > 0) {
                    const cloneListDiv = document.createElement('div');
                    cloneListDiv.className = 'clone-list';

                    clones.forEach((clone, index) => {
                        console.log(`[fetchClones] Processing clone index ${index}:`, clone.id);
                        const card = document.createElement('div');
                        card.className = 'clone-card';

                        const infoDiv = document.createElement('div');
                        infoDiv.className = 'clone-info';
                        const nameH2 = document.createElement('h2');
                        nameH2.textContent = clone.clone_name;
                        infoDiv.appendChild(nameH2);

                        if (clone.clone_description) {
                            const descP = document.createElement('p');
                            descP.className = 'clone-description';
                            descP.textContent = clone.clone_description;
                            infoDiv.appendChild(descP);
                        }

                        const actionsDiv = document.createElement('div');
                        actionsDiv.className = 'clone-actions';

                        // Manage link
                        const manageLink = document.createElement('a');
                        manageLink.href = '{{ url_for("manage_clone_page", clone_id="CLONE_ID") }}'.replace('CLONE_ID', clone.id);
                        manageLink.className = 'btn btn-secondary';
                        manageLink.textContent = 'Manage';
                        actionsDiv.appendChild(manageLink);

                        // *** NEW APPROACH: Two-step process with direct links ***
                        // Step 1: Create a link to select the clone
                        const selectLink = document.createElement('a');
                        selectLink.href = `/select-and-chat/${clone.id}`;
                        selectLink.className = 'btn';
                        selectLink.textContent = 'Chat';
                        actionsDiv.appendChild(selectLink);

                        card.appendChild(infoDiv);
                        card.appendChild(actionsDiv);
                        cloneListDiv.appendChild(card);
                    });
                    cloneListContainer.appendChild(cloneListDiv);
                    emptyState.style.display = 'none';
                } else {
                    console.log('[fetchClones] No clones found, displaying empty state.');
                    emptyState.style.display = 'block';
                }

            } catch (error) {
                console.error('[fetchClones] Error fetching or processing clones:', error);
                cloneListContainer.innerHTML = '<div class="error-state">Error loading clones. Please try again later.</div>';
                emptyState.style.display = 'none';
            }
        }

        console.log('[Clone Directory] Setting up DOMContentLoaded listener.');
        document.addEventListener('DOMContentLoaded', () => {
            console.log('[Clone Directory] DOMContentLoaded event fired. Calling fetchClones...');
            fetchClones();
        });
        console.log('[Clone Directory] Script block finished.');
    </script>
</body>
</html>
